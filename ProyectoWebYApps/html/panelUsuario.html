<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Usuario</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <h1>Panel del Usuario</h1>

    <!-- Botones principales del usuario -->
    <div id="userActions">
        <h2>Acciones</h2>
        <button id="createEventButton" onclick="showCreateEventForm()">Crear Evento</button>
        <button id="showEventsButton" onclick="showUserEvents()">Ver y Editar Mis Eventos</button>
    </div>
    <br>

    <!-- Formulario para crear y editar eventos -->
    <div id="eventFormContainer" class="hidden">
        <h2 id="formTitle">Crear Evento</h2>
        <form id="eventForm" action="/eventRegister" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="id_evento" value="">
            <input type="hidden" name="imagen_actual" value="">
            <input type="text" name="titulo" placeholder="Título del evento" required>
            <input type="date" name="fecha" required>
            <input type="time" name="hora_inicio" required>
            <input type="time" name="hora_fin" required>
            <input type="text" name="ubicacion" placeholder="Ubicación o Enlace" required>
            <input type="text" name="organizador" placeholder="Organizador" required>
            <input type="file" name="imagen_url" accept="image/*" onchange="previewImage(event)">
            <img id="imagePreview" style="max-width: 300px; display: none;">
            <textarea name="descripcion" placeholder="Descripción" required></textarea>
            <select name="categoria">
                <option value="Estudiantes">Evento para Estudiantes</option>
                <option value="Profesores">Evento para Profesores</option>
                <option value="Universidad">Evento para Comunidad Universitaria</option>
            </select>
            <button id="formSubmitButton" type="submit">Crear Evento</button>
            <button id="discardCreationButton" type="button" class="hidden" onclick="cancelCreation()">Cancelar Creación</button>
            <button id="discardChangesButton" type="button" class="hidden" onclick="discardChanges()">Descartar Cambios</button>
        </form>
    </div>

    <!-- Contenedor para mostrar eventos del usuario -->
    <div id="userEventsContainer" class="hidden">
        <h2>Mis Eventos</h2>
        <ul id="userEventsList">
            <!-- Los eventos se cargarán aquí dinámicamente -->
        </ul>
    </div>

    <br>
    <button onclick="window.location.href='/logout'">Volver</button>

    <!-- Script -->
    <script>
        // Mostrar el formulario para crear un evento
        function showCreateEventForm() {
            resetForm(); // Limpia el formulario
            document.getElementById('formTitle').textContent = 'Crear Evento';
            document.getElementById('eventForm').action = '/eventRegister';
            document.getElementById('formSubmitButton').textContent = 'Crear Evento';

            document.getElementById('eventFormContainer').classList.remove('hidden');
            document.getElementById('userEventsContainer').classList.add('hidden');
            document.getElementById('discardCreationButton').classList.remove('hidden');
            document.getElementById('discardChangesButton').classList.add('hidden');
        }

        // Mostrar la lista de eventos del usuario
        function showUserEvents() {
            document.getElementById('userEventsContainer').classList.remove('hidden');
            document.getElementById('eventFormContainer').classList.add('hidden');

            fetch('/userEvents')
                .then(response => response.json())
                .then(events => {
                    const userEventsList = document.getElementById('userEventsList');
                    userEventsList.innerHTML = '';

                    if (events.length === 0) {
                        userEventsList.innerHTML = '<li>No tienes eventos creados.</li>';
                        return;
                    }

                    events.forEach(event => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>${event.Nombre}</strong> - ${event.Fecha} ${event.Hora_Inicio} a ${event.Hora_Fin} - ${event.Categoria}
                            <button onclick="editEvent(${event.ID_EVENTO}, '${event.Nombre}', '${event.Descripcion}', '${event.Fecha}', '${event.Hora_Inicio}', '${event.Hora_Fin}', '${event.Ubicacion}', '${event.Organizador}', '${event.Categoria}', '${encodeURIComponent(event.imagen_url)}')">Editar</button>
                        `;
                        userEventsList.appendChild(listItem);
                    });
                })
                .catch(error => console.error('Error al cargar los eventos:', error));
        }

        // Editar un evento
        function editEvent(id, title, description, date, startTime, endTime, location, organizer, category, imagen_url) {
            resetForm();

            const eventForm = document.getElementById('eventForm');
            eventForm.action = '/updateEvent';

            // Actualizar valores del formulario
            document.querySelector('input[name="id_evento"]').value = id;
            document.querySelector('input[name="imagen_actual"]').value = decodeURIComponent(imagen_url);
            document.querySelector('input[name="titulo"]').value = title;
            document.querySelector('input[name="fecha"]').value = new Date(date).toISOString().split('T')[0];
            document.querySelector('input[name="hora_inicio"]').value = startTime;
            document.querySelector('input[name="hora_fin"]').value = endTime;
            document.querySelector('input[name="ubicacion"]').value = location;
            document.querySelector('input[name="organizador"]').value = organizer;
            document.querySelector('textarea[name="descripcion"]').value = description;
            document.querySelector(`select[name="categoria"] option[value="${category}"]`).selected = true;

            const preview = document.getElementById('imagePreview');
            preview.src = decodeURIComponent(imagen_url);
            preview.style.display = 'block';

            // Cambiar texto de formulario y mostrar botones
            document.getElementById('formTitle').textContent = 'Actualizar Evento';
            document.getElementById('formSubmitButton').textContent = 'Guardar Cambios';
            document.getElementById('discardCreationButton').classList.add('hidden');
            document.getElementById('discardChangesButton').classList.remove('hidden');

            document.getElementById('eventFormContainer').classList.remove('hidden');
            document.getElementById('userEventsContainer').classList.add('hidden');
        }

        // Cancelar creación de evento
        function cancelCreation() {
            document.getElementById('eventFormContainer').classList.add('hidden');
        }

        // Descartar cambios al editar
        function discardChanges() {
            document.getElementById('eventFormContainer').classList.add('hidden');
            document.getElementById('userEventsContainer').classList.remove('hidden');
        }

        // Resetear el formulario
        function resetForm() {
            const eventForm = document.getElementById('eventForm');
            eventForm.reset();

            document.querySelector('input[name="id_evento"]').value = '';
            document.querySelector('input[name="imagen_actual"]').value = '';
            document.getElementById('imagePreview').src = '';
            document.getElementById('imagePreview').style.display = 'none';

            document.getElementById('discardChangesButton').classList.add('hidden');
            document.getElementById('discardCreationButton').classList.add('hidden');
        }

        // Previsualizar imagen
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
    </script>
</body>
</html>
